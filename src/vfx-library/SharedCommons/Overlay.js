import Ready from 'ready.player.me.config'

export class Overlay {
  constructor({ api, container, children }) {
    let getSVGBG = (svg) => {
      let headerSVG = `data:image/svg+xml;utf8,`
      svg = svg.replace(/\n/, '')
      svg = svg.trim()
      return `${headerSVG}${encodeURIComponent(svg)}`
    }
    let iframe = document.createElement('iframe')

    let gear = document.createElement('div')

    let svgClothes = `<svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd"><path fill="#555555" d="M18 24h-12v-12l-3 10.357-3-.773 4-17.584 3.782-2.002c-.417 1.998.72 4.432 1.516 6.158.804-.703 1.301-1.157 2.7-2.252 1.394 1.093 1.822 1.485 2.7 2.251.83-1.796 1.935-4.186 1.518-6.158l3.784 2.003 4 17.584-3 .731-2.882-10.315-.118 12zm-6-3c.276 0 .5.224.5.5s-.224.5-.5.5-.5-.224-.5-.5.224-.5.5-.5zm0-3c.276 0 .5.224.5.5s-.224.5-.5.5-.5-.224-.5-.5.224-.5.5-.5zm0-3.001c.276 0 .5.224.5.5s-.224.5-.5.5-.5-.224-.5-.5.224-.5.5-.5zm0-2.998c.276 0 .5.224.5.5s-.224.5-.5.5-.5-.224-.5-.5.224-.5.5-.5zm0-3.001c.276 0 .5.224.5.5s-.224.5-.5.5-.5-.224-.5-.5.224-.5.5-.5zm-2.425-2.15c-2.099-4.546-1.049-6.858 2.422-6.846 2.888 0 4.823 1.646 2.422 6.846-.877-.766-2.162-1.76-2.422-1.959-.029-.023-2.389 1.93-2.422 1.959zm2.438-2.226c1.396-.419 3.992-3.633-.013-3.624-4.009.009-1.39 3.228-.003 3.629l.016-.005z"/></svg>`
    gear.style.cssText = `
      position: ${
        api.now.mode === 'square' || api.now.mode === 'boxfull'
          ? 'absolute'
          : 'fixed'
      };
      top: 100px;
      right: 40px;
      width: 50px;
      height: 50px;
      // border: white solid 3px;
      border-radius: 100%;
      z-index: 30px;
      user-select: none;
      background: rgba(255,255,255,0.6);
      color: black;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 14px;
      color: #777;
      text-align:center;
      padding: 10px;

      background: rgba(255,255,255,0.6);

      background-image: url("${getSVGBG(svgClothes)}");
      background-size: 60% 60%;
      background-position-x: 50%;
      background-position-y: 50%;
      background-repeat: no-repeat no-repeat;
    `

    // gear.innerHTML = `
    //   <svg xmlns="http://www.w3.org/2000/svg" width="24" height="26" viewBox="0 0 24 26"><path d="M16.5 14.5c0 .828-.56 1.5-1.25 1.5s-1.25-.672-1.25-1.5.56-1.5 1.25-1.5 1.25.672 1.25 1.5zm-7.75-1.5c-.69 0-1.25.672-1.25 1.5s.56 1.5 1.25 1.5 1.25-.672 1.25-1.5-.56-1.5-1.25-1.5zm3.25 8.354c2.235 0 3-2.354 3-2.354h-6s.847 2.354 3 2.354zm12-6.041c0 1.765-.985 3.991-3.138 4.906-2.025 3.233-4.824 5.781-8.862 5.781-3.826 0-6.837-2.548-8.862-5.781-2.153-.916-3.138-3.142-3.138-4.906 0-2.053.862-3.8 2.71-3.964.852-9.099 8.57-8.408 9.837-10.849.323.559.477 1.571-.02 2.286.873-.045 2.344-1.304 2.755-2.552.754.366 1.033 1.577.656 2.354.542-.103 2.187-1.15 3.062-2.588.688 1.563.026 3.563-.708 4.771l-.012.001c1.796 1.707 2.781 4.129 3.01 6.576 1.859.165 2.71 1.917 2.71 3.965zm-2.58-1.866c-.235-.152-.531-.115-.672-.053-.56.25-1.214-.062-1.372-.66l-.001.016c-.333-2.604-1.125-4.854-2.611-5.565-6.427 7.009-10.82-.914-11.94 3.529-.101.582-.166 1.172-.166 1.766 0 .719-.743 1.209-1.406.914-.14-.062-.437-.1-.672.053-1 .651-.894 4.184 1.554 5.012.224.076.413.228.535.43 2.447 4.053 5.225 5.111 7.331 5.111 3.288 0 5.615-2.269 7.332-5.111.122-.202.312-.354.535-.43 2.447-.828 2.553-4.361 1.553-5.012z"/></svg>
    // `;

    gear.addEventListener('pointerdown', () => {
      popup.style.display = 'block'
      iframe.src = Ready
    })
    container.appendChild(gear)

    let popup = document.createElement('div')

    try {
      iframe.classList.add('w-full')
      iframe.classList.add('h-full')
      iframe.allow = 'camera *; microphone *'

      popup.appendChild(iframe)
    } catch (e) {
      console.log(e)
    }

    let onReady = (url) => {
      api.now.myAvatarURL =
        url + '?rand=_rid_' + Math.floor(Math.random() * 1000000000)
      closeBtn.isVisible = false
      popup.style.display = 'none'
    }
    function receiveMessage(event) {
      setTimeout(() => {
        if (typeof event.data === 'string') {
          function validURL(str) {
            let pattern = new RegExp(
              '^(https?:\\/\\/)?' + // protocol
                '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|' + // domain name
                '((\\d{1,3}\\.){3}\\d{1,3}))' + // OR ip (v4) address
                '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' + // port and path
                '(\\?[;&a-z\\d%_.~+=-]*)?' + // query string
                '(\\#[-a-z\\d_]*)?$',
              'i'
            ) // fragment locator
            return !!pattern.test(str)
          }

          if (validURL(event.data)) {
            // console.log(event.data);
            onReady(event.data)
          }
        }
      }, 0)
    }

    window.addEventListener('message', receiveMessage, false)
    api.onClean(() => {
      window.removeEventListener('message', receiveMessage)
    })

    // let svgPopBG = `
    // <svg width="256px" height="256px" viewBox="0 0 256 256" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    //     <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
    //         <g id="Artboard">
    //             <g id="Group" transform="translate(38.000000, 30.000000)" fill="#555555" fill-rule="nonzero">
    //                 <path d="M124.4375,109.307692 C124.4375,115.549538 120.214167,120.615385 115.010417,120.615385 C109.806667,120.615385 105.583333,115.549538 105.583333,109.307692 C105.583333,103.065846 109.806667,98 115.010417,98 C120.214167,98 124.4375,103.065846 124.4375,109.307692 Z M65.9895833,98 C60.7858333,98 56.5625,103.065846 56.5625,109.307692 C56.5625,115.549538 60.7858333,120.615385 65.9895833,120.615385 C71.1933333,120.615385 75.4166667,115.549538 75.4166667,109.307692 C75.4166667,103.065846 71.1933333,98 65.9895833,98 Z M90.5,160.976308 C107.355625,160.976308 113.125,143.230769 113.125,143.230769 L67.875,143.230769 C67.875,143.230769 74.2627917,160.976308 90.5,160.976308 Z M181,115.436462 C181,128.741846 173.571458,145.522462 157.33425,152.420154 C142.062375,176.792 120.95325,196 90.5,196 C61.6455833,196 38.937625,176.792 23.66575,152.420154 C7.42854167,145.514923 0,128.734308 0,115.436462 C0,99.96 6.50091667,86.7903077 20.4379167,85.554 C26.8634167,16.9615385 85.07,22.1706154 94.6252917,3.76923077 C97.06125,7.98323077 98.2226667,15.6121538 94.4744583,21.0021538 C101.058333,20.6629231 112.152125,11.172 115.25175,1.764 C120.938167,4.52307692 123.042292,13.6521538 120.199083,19.5095385 C124.286667,18.7330769 136.692708,10.8403077 143.291667,0 C148.480333,11.7826154 143.48775,26.8595385 137.952167,35.966 L137.861667,35.9735385 C151.4065,48.8416923 158.835042,67.0998462 160.562083,85.5464615 C174.582042,86.7903077 181,99.9976923 181,115.436462 Z M161.5425,101.369692 C159.770208,100.223846 157.537875,100.502769 156.4745,100.970154 C152.251167,102.854769 147.318917,100.502769 146.127333,95.9947692 L146.119792,96.1153846 C143.608417,76.4852308 137.635417,59.5236923 126.4285,54.1638462 C77.9582083,107.000923 44.8276667,47.2736923 36.381,80.7670769 C35.6192917,85.1544615 35.1290833,89.6021538 35.1290833,94.08 C35.1290833,99.5001538 29.525625,103.194 24.5255,100.970154 C23.4696667,100.502769 21.2297917,100.216308 19.4575,101.369692 C11.9158333,106.277231 12.71525,132.910615 31.17725,139.152462 C32.8665833,139.725385 34.2919583,140.871231 35.2120417,142.394 C53.6665,172.947385 74.61725,180.923077 90.5,180.923077 C115.297,180.923077 132.846458,163.818308 145.7955,142.394 C146.715583,140.871231 148.1485,139.725385 149.830292,139.152462 C168.28475,132.910615 169.084167,106.277231 161.5425,101.369692 Z" id="Shape"></path>
    //             </g>
    //             <rect id="Rectangle" x="0" y="0" width="256" height="256"></rect>
    //         </g>
    //     </g>
    // </svg>`;

    let svgPopBG = `

    <svg width="512px" height="512px" viewBox="0 0 512 512" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="clothes">
            <g id="Group" transform="translate(50.264706, 41.404412)" fill="#000000">
                <path d="M82.4183226,24.2485751 C83.7210852,26.8616717 88.523577,31.1937082 92.3008177,33.2363944 C96.2245228,31.1397504 100.88055,26.7845893 102.160187,24.2485751 C100.926802,23.7012893 98.1208518,22.8456736 92.2776917,22.5990096 C86.4422402,22.8302571 83.63629,23.7012893 82.4183226,24.2485751 M92.2854004,14.8830515 L92.5012427,14.8907597 C126.689126,16.2088705 102.537911,38.4240465 92.4087388,41.5304712 L92.2854004,41.5613042 C82.2024803,38.593628 57.6504156,16.1240797 92.2854004,14.8830515 M92.2160225,91.3103487 C89.6567492,91.3103487 87.5908298,93.3838679 87.5908298,95.9352986 C87.5908298,98.4867293 89.6567492,100.560248 92.2160225,100.560248 C94.7675871,100.560248 96.8412152,98.4867293 96.8412152,95.9352986 C96.8412152,93.3838679 94.7675871,91.3103487 92.2160225,91.3103487 M92.2160225,114.373432 C89.6567492,114.373432 87.5908298,116.446951 87.5908298,118.998382 C87.5908298,121.549813 89.6567492,123.63104 92.2160225,123.63104 C94.7675871,123.63104 96.8412152,121.549813 96.8412152,118.998382 C96.8412152,116.446951 94.7675871,114.373432 92.2160225,114.373432 M92.2160225,68.1316414 C89.6567492,68.1316414 87.5908298,70.2051606 87.5908298,72.7565913 C87.5908298,75.308022 89.6567492,77.3815412 92.2160225,77.3815412 C94.7675871,77.3815412 96.8412152,75.308022 96.8412152,72.7565913 C96.8412152,70.2051606 94.7675871,68.1316414 92.2160225,68.1316414 M159.759253,165.47142 L175.677625,161.601879 L150.478033,40.6517307 L125.363237,27.362708 C125.925969,42.3475457 118.995888,56.6078079 112.582288,70.7370298 C112.582288,70.7370298 95.885342,56.2223954 92.2854004,53.33951 C88.3462779,56.5153089 71.9808043,70.7293216 71.9808043,70.7293216 C65.3590701,56.0759386 58.6371234,41.9004672 59.2152725,27.2779172 L33.9463029,40.6517307 L8.77754588,161.856251 L24.6959175,165.949332 L46.0411819,90.9943104 L53.6881672,92.0965901 L53.6881672,176.887338 L130.774712,176.887338 L130.774712,92.0965901 L138.35232,90.9866022 L159.759253,165.47142 Z M74.6865421,58.0107094 C80.4371984,52.877015 92.2854004,43.5037832 92.2854004,43.5037832 C92.2854004,43.5037832 103.51691,52.3374375 109.884259,58.0107094 C125.085725,24.4721143 117.585205,7.35979965 92.5783292,7.3058419 L92.1081013,7.3058419 C67.0241395,7.3058419 59.4619494,24.4181565 74.6865421,58.0107094 M184.735294,167.23661 L154.409447,174.72132 L138.429406,119.160255 L138.259816,184.595588 L45.8947174,184.595588 L45.8947174,119.661292 L30.061141,175.284022 L-0.264705882,167.483274 L27.139561,35.5334528 L61.0576409,17.5809389 C67.7102097,-0.857194678 88.6777501,-0.403413072 92.5937466,-0.403413072 C98.7144182,-0.386991437 117.353945,0.360708797 123.551703,17.6734379 L157.292484,35.5334528 L184.735294,167.23661 L184.735294,167.23661 Z M92.2160225,137.721721 C89.6567492,137.721721 87.5908298,139.787532 87.5908298,142.338963 C87.5908298,144.890393 89.6567492,146.963913 92.2160225,146.963913 C94.7675871,146.963913 96.8412152,144.890393 96.8412152,142.338963 C96.8412152,139.787532 94.7675871,137.721721 92.2160225,137.721721 M96.8412152,165.309547 C96.8412152,167.860978 94.7675871,169.926789 92.2160225,169.926789 C89.6567492,169.926789 87.5908298,167.860978 87.5908298,165.309547 C87.5908298,162.758116 89.6567492,160.684597 92.2160225,160.684597 C94.7675871,160.684597 96.8412152,162.758116 96.8412152,165.309547" id="Shape"></path>
            </g>
            <g id="Group" transform="translate(85.933824, 285.683824)" fill="#000000">
                <path d="M43.4739265,11.6474265 C43.4739265,9.9438848 44.8611765,8.56409314 46.5661765,8.56409314 C48.2789265,8.56409314 49.6661765,9.9438848 49.6661765,11.6474265 C49.6661765,13.3509681 48.2789265,14.7307598 46.5661765,14.7307598 C44.8611765,14.7307598 43.4739265,13.3509681 43.4739265,11.6474265 M68.7931765,177.607843 L51.0689265,54.2745098 L42.0634265,54.2745098 L24.3469265,177.607843 L7.81617647,177.607843 L7.81617647,50.2815931 C13.2411765,49.4876348 18.0384265,47.5605515 22.0994265,44.4078431 C28.1521765,39.6980515 32.2209265,32.2980515 34.0731765,23.4411765 L59.0591765,23.4411765 C60.9114265,32.2980515 64.9801765,39.7057598 71.0406765,44.4078431 C75.1094265,47.5759681 79.8834265,49.5493015 85.3161765,50.3586765 L85.3161765,177.607843 L68.7931765,177.607843 L68.7931765,177.607843 Z M26.2146765,23.4411765 C24.6181765,29.8005515 21.5879265,35.0190931 17.3254265,38.3336765 C14.6361765,40.4226348 11.4431765,41.7870098 7.81617647,42.4961765 L7.81617647,23.4411765 L26.2146765,23.4411765 Z M85.3161765,23.4411765 L85.3161765,42.4345098 C81.7124265,41.7407598 78.4961765,40.4149265 75.8146765,38.3336765 C71.5521765,35.0190931 68.5219265,29.8005515 66.9176765,23.4411765 L85.3161765,23.4411765 Z M85.3161765,15.7328431 L7.81617647,15.7328431 L7.81617647,8.0245098 L85.3161765,8.0245098 L85.3161765,15.7328431 Z M0.0661764706,0.316176471 L0.0661764706,185.316176 L31.0661765,185.316176 L46.5661765,77.3995098 L62.0661765,185.316176 L93.0661765,185.316176 L93.0661765,0.316176471 L0.0661764706,0.316176471 Z" id="Shape"></path>
            </g>
            <g id="Group" transform="translate(297.786765, 36.000000)" fill="#000000">
                <path d="M116.807135,185.42173 L102.194185,147.026527 L106.554435,186.613418 C98.9015853,187.364344 90.5233853,187.837755 81.4768853,187.837755 C72.7971353,187.837755 64.7286353,187.405156 57.3528853,186.727689 L61.7212853,147.026527 L47.0512853,185.560488 C29.9770353,183.258735 17.6705353,179.789781 11.6313853,177.822679 L56.6682853,89.8908091 L107.785085,89.8908091 L151.876585,177.602299 C145.878185,179.5694 133.702085,183.062841 116.807135,185.42173 M45.7717353,45.2106775 L25.8612853,51.7567984 L17.4993853,38.4523383 L50.8573353,10.2028068 C53.4164353,17.2468246 62.2754853,36.8362137 81.8436353,36.8362137 C102.560935,36.8362137 110.441985,15.5654021 112.202385,9.81101903 L146.179735,38.4605006 L137.825985,51.7567984 L117.834035,45.1861908 L108.322985,81.7285637 L56.0407353,81.7285637 L45.7717353,45.2106775 Z M102.063785,13.3126223 C98.9423353,19.8424187 92.6994353,28.6739683 81.8436353,28.6739683 C71.2486353,28.6739683 64.6389853,19.9322034 61.1018853,13.1738642 C76.8313853,18.1201849 88.0620853,17.6630992 102.063785,13.3126223 M115.397185,86.8952651 L123.530885,55.6501895 L141.330485,61.4943572 L156.864385,36.7954025 L113.212985,0 C106.049135,3.57506351 83.6121853,16.4714113 50.2786853,0.00816224545 L6.82288529,36.8035647 L22.3567853,61.4943572 L40.2297353,55.6257027 L49.0317353,86.9115896 L0.213235294,182.22213 L4.34528529,183.903552 C5.56778529,184.401449 34.7040353,196 81.4768853,196 C128.249735,196 157.883135,184.189231 159.113785,183.675009 L163.213235,182.018074 L115.397185,86.8952651 Z" id="Shape"></path>
            </g>
            <g id="Group" transform="translate(323.727941, 292.169118)" fill="#000000">
                <path d="M88.6936838,-0.169117647 L113.016934,4.81046569 C104.629871,28.243799 107.512684,39.9527574 107.789434,41.4096324 C111.148871,58.9229657 120.558371,67.440674 123.256684,69.683799 L123.272059,184.830882 L0.272058824,184.830882 L0.272058824,69.6760907 C3.03955882,67.4252574 12.4106213,58.8535907 15.7546838,41.4096324 C15.9929963,40.1377574 18.6913088,29.006924 10.6963088,4.81817402 L34.7428088,-0.0997426471 C45.5514338,15.2321324 58.2127463,15.7640074 61.6951838,15.7640074 C71.8196213,15.7640074 81.5058713,9.96734069 88.6936838,-0.169117647 Z M7.95955882,177.122549 L115.584559,177.122549 L115.584559,73.198799 C112.148246,69.8379657 103.515184,59.948174 100.240309,42.858799 C97.9571213,30.9417157 101.024434,17.3596324 102.946309,10.622549 L94.7744963,8.96525735 C91.0998713,27.2802574 84.4194338,53.773799 61.7720588,53.773799 C39.0401213,53.773799 32.3519963,27.2802574 28.6773713,8.95754902 L20.5593713,10.6379657 C22.4043713,17.4983824 25.4639963,31.5583824 23.3038088,42.858799 C20.0289338,59.948174 11.3958713,69.8379657 7.95955882,73.198799 L7.95955882,177.122549 L7.95955882,177.122549 Z M37.2796838,13.5054657 C40.4161838,27.550049 46.9044338,46.073174 61.7720588,46.073174 C76.6089338,46.073174 83.0818088,27.526924 86.1798713,13.5517157 C80.6909963,18.4542157 72.4807463,23.4492157 61.7028713,23.4260907 C52.8622463,23.4029657 44.4598088,19.941924 37.2796838,13.5054657 Z" id="Shape"></path>
            </g>
            <rect id="Rectangle" x="0" y="0" width="512" height="512"></rect>
        </g>
    </g>
</svg>
    `
    popup.style.cssText = `
      position: ${
        api.now.mode === 'square' || api.now.mode === 'boxfull'
          ? 'absolute'
          : 'fixed'
      };
      top: 0px;
      right: 0px;
      width: 100%;
      height: 100%;
      z-index: 40px;
      user-select: none;
      background: rgba(255,255,255,0.6);

      background-image: url("${getSVGBG(svgPopBG)}");
      background-size: 50% 50%;
      background-position-x: 50%;
      background-position-y: 50%;
      background-repeat: no-repeat no-repeat;
    `
    popup.style.display = 'none'
    popup.isVisible = false

    if (children) {
      popup.appendChild(children)
    }
    container.appendChild(popup)

    let closeBtn = document.createElement('div')
    closeBtn.innerHTML = `
    `

    let svgClose = `<svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd"><path fill="#fff" d="M12 0c6.623 0 12 5.377 12 12s-5.377 12-12 12-12-5.377-12-12 5.377-12 12-12zm0 1c6.071 0 11 4.929 11 11s-4.929 11-11 11-11-4.929-11-11 4.929-11 11-11zm0 10.293l5.293-5.293.707.707-5.293 5.293 5.293 5.293-.707.707-5.293-5.293-5.293 5.293-.707-.707 5.293-5.293-5.293-5.293.707-.707 5.293 5.293z"/></svg>`

    closeBtn.style.cssText = `
    z-index: 80;

      position: ${
        api.now.mode === 'square' || api.now.mode === 'boxfull'
          ? 'absolute'
          : 'fixed'
      };

      top: 0px;
      right: 0px;

      width: 50px;
      height: 50px;

      border-radius: 0px 0px 0px 100px;
      user-select: none;
      background: rgba(255,100,100,0.6);
      color: black;
      display: flex;
      justify-content: flex-end;
      align-items: flex-start;
      font-size: 14px;
      color: #777;
      text-align:right;

      background-image: url("${getSVGBG(svgClose)}");
      background-size: 50% 50%;
      background-position-x: 75%;
      background-position-y: 25%;
      background-repeat: no-repeat no-repeat;
    `

    popup.appendChild(closeBtn)
    closeBtn.addEventListener('pointerdown', () => {
      closeBtn.isVisible = !closeBtn.isVisible
      popup.style.display = 'none'
      iframe.src = ''
    })

    this.popup = popup
  }
}
